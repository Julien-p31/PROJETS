# Tutoriel : DÃ©tecter les attaques de DNS spoofing

## ğŸ¯ Objectif  
Simuler et dÃ©tecter une attaque de DNS spoofing (cache poisoning ou MITM) sur un rÃ©seau local, en analysant le trafic DNS via Python et Scapy, Wireshark ou Zeek.

## ğŸ§  ScÃ©nario dâ€™ancrage  
Un collÃ¨gue reÃ§oit systÃ©matiquement de fausses rÃ©ponses DNS et visite une fausse page bancaire. Vous devez dÃ©couvrir et dÃ©montrer cette attaque afin de restaurer la sÃ©curitÃ©.

---

## ğŸ› ï¸ PrÃ©requis  
- Linux (Debian/Ubuntu/Kali)  
- Pythonâ€¯3 et `pip install scapy`  
- Ou `sudo apt install dnstop wireshark zeek`  
- Carte rÃ©seau supportant le mode promiscuitÃ©

---

## ğŸ”§ Ã‰tape 1 â€“ Capturer les paquets DNS

**Avec Wireshark**  
- Lancer capture sur interface (ex. `eth0`)  
- Appliquer filtre `dns`  
- Recherchez des requÃªtes rÃ©pÃ©tÃ©es avec rÃ©ponses non attendues (ex. TTL trÃ¨s bas, mismatch IP / domaine)  [oai_citation:0â€¡Medium](https://medium.com/%40allypetitt/practical-demonstration-dns-spoofing-home-lab-f7294443fb23?utm_source=chatgpt.com) [oai_citation:1â€¡GitHub](https://github.com/Trackbool/DerpNSpoof?utm_source=chatgpt.com) [oai_citation:2â€¡WebAsha](https://www.webasha.com/blog/how-to-defend-against-dns-spoofing-tools-techniques-and-real-world-defenses?utm_source=chatgpt.com)  

**Avec Zeek/tcpdump/dnstop**  
```bash
sudo tcpdump -i eth0 -s 0 -w dns.pcap udp port 53
dnstop -r dns.pcap

	â€¢	Zones suspectes : rÃ©ponses provenant dâ€™un serveur non autorisÃ©, IP non cohÃ©rente ()

â¸»

ğŸ§© Ã‰tape 2 â€“ DÃ©tecter en Python avec Scapy

from scapy.all import sniff, DNS, DNSRR
import time

def detect(pkt):
    if pkt.haslayer(DNS) and pkt.getlayer(DNS).qr == 1:
        for i in range(pkt[DNS].ancount):
            rr = pkt[DNSRR][i]
            # domaine inattendu ou IP non autorisÃ©e
            if "example.com." in rr.rrname.decode() and rr.rdata != "93.184.216.34":
                print(f"[{time.strftime('%H:%M:%S')}] âš ï¸ DNS spoofing dÃ©tectÃ© : {rr.rrname.decode()} -> {rr.rdata}")

sniff(filter="udp port 53", prn=detect, store=False)

âœ… Le script affiche les cas oÃ¹ example.com rÃ©sout vers une IP incorrecte.

â¸»

ğŸ§  Ã‰tape 3 â€“ Simuler lâ€™attaque

Avec Scapy + NetfilterQueue :
	1.	Ajoutez une rÃ¨gle iptables :

sudo iptables -I FORWARD -p udp --dport 53 -j NFQUEUE --queue-num 1

	2.	ExÃ©cutez un petit script DNS spoofer  ï¿¼
	3.	Testez depuis un client :

dig example.com @<ptr>

	4.	Le script prÃ©cÃ©dant doit dÃ©tecter la rÃ©ponse falsifiÃ©e.

â¸»

ğŸ§  Ã‰tape 4 â€“ Analyse et alertes
	â€¢	Comparez les logs Scapy avec les rÃ©ponses rÃ©elles
	â€¢	CrÃ©ez un rapport : horodatage, domaine, IP attendue vs reÃ§ue
	â€¢	Exportez CSV pour suivi long terme ou ingestion SIEM

â¸»

ğŸ§© PiÃ¨ges & aspects Ã  surveiller
	â€¢	TTL bas (<300s) ou source IP du serveur inattendue
	â€¢	RÃ©ponses DNS bidouillÃ©es envoyÃ©es avant la rÃ©ponse lÃ©gitime
	â€¢	Risque lÃ©gal : nâ€™effectuez ce test que sur votre rÃ©seau, dans un lab (â€œsafe workspaceâ€)

â¸»

ğŸ§ª Quiz de consolidation
	1.	Quel champ indique une rÃ©ponse DNS (qr == 1) ?
	2.	Pourquoi comparer IP reÃ§ue vs zone officielle ?
	3.	Comment Zeek dÃ©tecte une rÃ©ponse suspecte ?
	4.	Que fait NFQUEUE ?
	5.	Pourquoi les TTL trop bas sont-ils suspects ?

â¸»

âœ… Extensions possibles
	â€¢	Automatiser pour filtrer domaines critiques (ex. banque)
	â€¢	Ajout dâ€™alertes Slack/email dÃ¨s dÃ©tection
	â€¢	IntÃ©gration Zeek avec script pour gÃ©nÃ©rer logs suspects
	â€¢	Utiliser DNSSEC comme contre-mesure et validation  ï¿¼ ï¿¼ ï¿¼ ï¿¼ ï¿¼ ï¿¼ ï¿¼

â¸»

ğŸ“ RÃ©sultat attendu
	â€¢	Script Scapy capable dâ€™alerter en temps rÃ©el
	â€¢	Attaque DNS spoofing simulÃ©e dans un lab contrÃ´lÃ©
	â€¢	Rapport clair avec preuve de faconnage DNS
	â€¢	Sensibilisation et meilleure posture rÃ©seau

Sources :
- DÃ©tection anomalies DNS via monitoring & TTL/IP  [oai_citation:11â€¡geeksforgeeks.org](https://www.geeksforgeeks.org/computer-networks/dns-spoofing-or-dns-cache-poisoning/?utm_source=chatgpt.com)  
- Exemples de DNS spoofing avec Scapy / NetfilterQueue  [oai_citation:12â€¡GitHub](https://github.com/Simone-Zabberoni/scapy-nfqueue-dnsspoof?utm_source=chatgpt.com)  
- Pratiques de dÃ©fense : DNSSEC, TLS/DHCP stratÃ©gie  [oai_citation:13â€¡ally-petitt.com](https://ally-petitt.com/en/posts/2023-03-28_practical-demonstration--dns-spoofing---home-lab-f7294443fb23/?utm_source=chatgpt.com)