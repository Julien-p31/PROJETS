# Tutoriel : Pratiquer les techniques dâ€™obfuscation de malware

## ğŸ¯ Objectif  
Appliquer des techniques dâ€™obfuscation courantes Ã  un malware simple (Python ou binaire) pour comprendre comment elles entravent lâ€™analyse statique et dynamique, tout en conservant leur fonction.

## ğŸ§  ScÃ©nario dâ€™ancrage Ã©motionnel  
Un analyste SOC dÃ©tecte un dropper mais ne parvient pas Ã  lâ€™analyser Ã  cause de multiples couches dâ€™obfuscationâ€¯: base64, junk code, packing. Vous devez reproduire ces techniques pour Ã©valuer leur efficacitÃ©.

---

## ğŸ› ï¸ PrÃ©requis  
- Linux (Ubuntu)  
- Pythonâ€¯3.9+ + pip  
- Outils : `upx`, `radare2`, `any.run`, `scp`, `netcat`  
- Librairies Python :  
  ```bash
  pip install pygments


â¸»

ğŸ§© Ã‰tapeâ€¯1 â€“ Base : un dropper Python simple

# dropper.py
import base64, subprocess
payload = base64.b64decode("cHJpbnQoIkhlbGxvIHdvcmxkIik=")
exec(payload)

Testez-le : output â€œHello worldâ€.

â¸»

ğŸ§© Ã‰tapeâ€¯2 â€“ Encodage et chiffrement
	1.	Obfuscation de chaÃ®ne Base64â€¯: comme ci-dessus.
	2.	Ajoutez XOR simple :

key = 0x42
enc = ''.join(chr(ord(c)^key) for c in payload)

Ajoutez le dÃ©chiffrement avant exec.

â¸»

ğŸ§© Ã‰tapeâ€¯3 â€“ Insertion de junk code & renommage

Ajoutez des blocs inutiles (fonctions vides) et renommez variablesâ€¯:

def zQx():
    pass

_a = enc.decrypt  # variable bidon
...

â†’ Rend lâ€™analyse statique confuse  ï¿¼ ï¿¼ ï¿¼.

â¸»

ğŸ§© Ã‰tapeâ€¯4 â€“ Packing binaire avec UPX

Compilez votre script en binaire (pyinstaller), puis :

upx --ultra-brute dropper

â†’ Lâ€™outil upx compresse/crypte le binaire, difficile Ã  analyser statiquement  ï¿¼.

â¸»

ğŸ§© Ã‰tapeâ€¯5 â€“ Polymorphisme & antiâ€‘dÃ©bogage
	1.	Renommez alÃ©atoirement fonctions/variables.
	2.	Ajoutez anti-debug :

import sys
if hasattr(sys, 'gettrace') and sys.gettrace():
    sys.exit()

â†’ Ã‰chappe aux environnements dâ€™analyse  ï¿¼ ï¿¼.

â¸»

ğŸ§© Ã‰tapeâ€¯6 â€“ Stegomalware lÃ©ger

Cachez une chaÃ®ne ou payload dans un fichier image :

with open("image.png","ab") as f:
    f.write(b"SECRET_PAYLOAD")

Puis rÃ©cupÃ©rez-la Ã  lâ€™exÃ©cution  ï¿¼.

â¸»

ğŸ” Ã‰tapeâ€¯7 â€“ Tentative dâ€™analyse inversÃ©e
	â€¢	Ouvrez le binaire avec radare2â€¯: difficiles Ã  suivre Ã  cause de lâ€™anti-debug et packing.
	â€¢	Lancez dans any.run ou sandbox locale : observez la dÃ©compression en RAM  ï¿¼ ï¿¼.
	â€¢	DÃ©compressez UPX :

upx -d dropper

â†’ Montrez comment dÃ©sobfusquer.

â¸»

ğŸ§  Ã‰tapeâ€¯8 â€“ Comparaison efficacitÃ© vs dÃ©tection

Technique	DÃ©tournement signature	DÃ©tournement analyse dynamique
Base64/XOR	++	+
Junk code + renommage	+	+
Packing UPX	+++	+
Anti-debug	++	++
Polymorphisme	++++	++++
Stegomalware	++	+

Explication de lâ€™effet dâ€™ensemble  ï¿¼ ï¿¼.

â¸»

ğŸ§ª Quiz de consolidation
	1.	Quelle diffÃ©rence entre encodage et chiffrement ?
	2.	Pourquoi le packing UPX empÃªche lâ€™analyse statiqueâ€¯?
	3.	Quel est lâ€™objectif du anti-debugâ€¯?
	4.	Quâ€™est-ce que le polymorphismeâ€¯?
	5.	Comment la stÃ©ganographie amÃ©liore lâ€™obfuscationâ€¯?

â¸»

âœ… Cas dâ€™usage
	â€¢	Formations red team vs blue team
	â€¢	Ã‰valuation dâ€™outils anti-malware
	â€¢	Conception de sandbox rÃ©sistantes

â¸»

ğŸ”§ Extensions possibles
	â€¢	Ajout de metamorphisme (rÃ©Ã©criture complÃ¨te du code)
	â€¢	C2 chiffrÃ©e, timer-based execution
	â€¢	Analyse mÃ©moire avec frida ou gdb pour debugger le chiffrement

â¸»

ğŸ“ RÃ©sultat attendu
	â€¢	Un malware expÃ©rimental multi-couche obfusquÃ©
	â€¢	CapacitÃ© Ã  Ã©valuer ses limites via reprise ultÃ©rieure
	â€¢	ComprÃ©hension approfondie des techniques anti-analyse

---

### ğŸ“š Sources utiles  
- Encodage, chiffrement, packing & anti-debug  [oai_citation:11â€¡socinvestigation.com](https://www.socinvestigation.com/most-common-malware-obfuscation-techniques/?utm_source=chatgpt.com) [oai_citation:12â€¡Wikipedia](https://en.wikipedia.org/wiki/Polymorphic_code?utm_source=chatgpt.com) [oai_citation:13â€¡VMRay](https://www.vmray.com/malware-obfuscation-techniques/?utm_source=chatgpt.com) [oai_citation:14â€¡miltonmenchaca.github.io](https://miltonmenchaca.github.io/MiltonM.github.io/posts/Malware-with-python/?utm_source=chatgpt.com) [oai_citation:15â€¡PeerJ](https://peerj.com/articles/cs-1002/?utm_source=chatgpt.com) [oai_citation:16â€¡Cyber Security News](https://cybersecuritynews.com/malware-obfuscation/?utm_source=chatgpt.com) [oai_citation:17â€¡stackzero.net](https://www.stackzero.net/malware-obfuscation-techniques/?utm_source=chatgpt.com)  
- Examples Python bytecode & opcodes  [oai_citation:18â€¡TrustedSec](https://www.trustedsec.com/blog/obfuscation-using-python-bytecode?utm_source=chatgpt.com)  
- UPX & polymorphism explained  [oai_citation:19â€¡ResearchGate](https://www.researchgate.net/figure/Malware-obfuscation-techniques-a-original-malware-assembly-code-b-after-applying_fig1_361327725?utm_source=chatgpt.com)