# Tutoriel : Pratiquer les techniques d’obfuscation de malware

## 🎯 Objectif  
Appliquer des techniques d’obfuscation courantes à un malware simple (Python ou binaire) pour comprendre comment elles entravent l’analyse statique et dynamique, tout en conservant leur fonction.

## 🧠 Scénario d’ancrage émotionnel  
Un analyste SOC détecte un dropper mais ne parvient pas à l’analyser à cause de multiples couches d’obfuscation : base64, junk code, packing. Vous devez reproduire ces techniques pour évaluer leur efficacité.

---

## 🛠️ Prérequis  
- Linux (Ubuntu)  
- Python 3.9+ + pip  
- Outils : `upx`, `radare2`, `any.run`, `scp`, `netcat`  
- Librairies Python :  
  ```bash
  pip install pygments


⸻

🧩 Étape 1 – Base : un dropper Python simple

# dropper.py
import base64, subprocess
payload = base64.b64decode("cHJpbnQoIkhlbGxvIHdvcmxkIik=")
exec(payload)

Testez-le : output “Hello world”.

⸻

🧩 Étape 2 – Encodage et chiffrement
	1.	Obfuscation de chaîne Base64 : comme ci-dessus.
	2.	Ajoutez XOR simple :

key = 0x42
enc = ''.join(chr(ord(c)^key) for c in payload)

Ajoutez le déchiffrement avant exec.

⸻

🧩 Étape 3 – Insertion de junk code & renommage

Ajoutez des blocs inutiles (fonctions vides) et renommez variables :

def zQx():
    pass

_a = enc.decrypt  # variable bidon
...

→ Rend l’analyse statique confuse  ￼ ￼ ￼.

⸻

🧩 Étape 4 – Packing binaire avec UPX

Compilez votre script en binaire (pyinstaller), puis :

upx --ultra-brute dropper

→ L’outil upx compresse/crypte le binaire, difficile à analyser statiquement  ￼.

⸻

🧩 Étape 5 – Polymorphisme & anti‑débogage
	1.	Renommez aléatoirement fonctions/variables.
	2.	Ajoutez anti-debug :

import sys
if hasattr(sys, 'gettrace') and sys.gettrace():
    sys.exit()

→ Échappe aux environnements d’analyse  ￼ ￼.

⸻

🧩 Étape 6 – Stegomalware léger

Cachez une chaîne ou payload dans un fichier image :

with open("image.png","ab") as f:
    f.write(b"SECRET_PAYLOAD")

Puis récupérez-la à l’exécution  ￼.

⸻

🔍 Étape 7 – Tentative d’analyse inversée
	•	Ouvrez le binaire avec radare2 : difficiles à suivre à cause de l’anti-debug et packing.
	•	Lancez dans any.run ou sandbox locale : observez la décompression en RAM  ￼ ￼.
	•	Décompressez UPX :

upx -d dropper

→ Montrez comment désobfusquer.

⸻

🧠 Étape 8 – Comparaison efficacité vs détection

Technique	Détournement signature	Détournement analyse dynamique
Base64/XOR	++	+
Junk code + renommage	+	+
Packing UPX	+++	+
Anti-debug	++	++
Polymorphisme	++++	++++
Stegomalware	++	+

Explication de l’effet d’ensemble  ￼ ￼.

⸻

🧪 Quiz de consolidation
	1.	Quelle différence entre encodage et chiffrement ?
	2.	Pourquoi le packing UPX empêche l’analyse statique ?
	3.	Quel est l’objectif du anti-debug ?
	4.	Qu’est-ce que le polymorphisme ?
	5.	Comment la stéganographie améliore l’obfuscation ?

⸻

✅ Cas d’usage
	•	Formations red team vs blue team
	•	Évaluation d’outils anti-malware
	•	Conception de sandbox résistantes

⸻

🔧 Extensions possibles
	•	Ajout de metamorphisme (réécriture complète du code)
	•	C2 chiffrée, timer-based execution
	•	Analyse mémoire avec frida ou gdb pour debugger le chiffrement

⸻

🎓 Résultat attendu
	•	Un malware expérimental multi-couche obfusqué
	•	Capacité à évaluer ses limites via reprise ultérieure
	•	Compréhension approfondie des techniques anti-analyse

---

### 📚 Sources utiles  
- Encodage, chiffrement, packing & anti-debug  [oai_citation:11‡socinvestigation.com](https://www.socinvestigation.com/most-common-malware-obfuscation-techniques/?utm_source=chatgpt.com) [oai_citation:12‡Wikipedia](https://en.wikipedia.org/wiki/Polymorphic_code?utm_source=chatgpt.com) [oai_citation:13‡VMRay](https://www.vmray.com/malware-obfuscation-techniques/?utm_source=chatgpt.com) [oai_citation:14‡miltonmenchaca.github.io](https://miltonmenchaca.github.io/MiltonM.github.io/posts/Malware-with-python/?utm_source=chatgpt.com) [oai_citation:15‡PeerJ](https://peerj.com/articles/cs-1002/?utm_source=chatgpt.com) [oai_citation:16‡Cyber Security News](https://cybersecuritynews.com/malware-obfuscation/?utm_source=chatgpt.com) [oai_citation:17‡stackzero.net](https://www.stackzero.net/malware-obfuscation-techniques/?utm_source=chatgpt.com)  
- Examples Python bytecode & opcodes  [oai_citation:18‡TrustedSec](https://www.trustedsec.com/blog/obfuscation-using-python-bytecode?utm_source=chatgpt.com)  
- UPX & polymorphism explained  [oai_citation:19‡ResearchGate](https://www.researchgate.net/figure/Malware-obfuscation-techniques-a-original-malware-assembly-code-b-after-applying_fig1_361327725?utm_source=chatgpt.com)