# Tutoriel : CrÃ©er un systÃ¨me dâ€™authentification Ã  deux facteurs (2FA)

## ğŸ¯ Objectif  
Ajouter une couche de sÃ©curitÃ© avec un deuxiÃ¨me facteur (TOTP), compatible GoogleÂ Authenticator/Fï»¿reeOTP, dans une application Flask.

## ğŸ§  ScÃ©nario dâ€™ancrage Ã©motionnel  
Un utilisateur malveillant a dÃ©couvert votre mot de passe, mais grÃ¢ce au 2FA, il ne peut pas accÃ©der Ã  votre compte sans le tÃ©lÃ©phoneâ€¯: la double barriÃ¨re vous protÃ¨ge.

---

## ğŸ› ï¸ PrÃ©requis  
- Linux ou macOS (ou VM) avec PythonÂ 3.8+  
- Installer les dÃ©pendances :  
  ```bash
  pip install flask flask-login flask-sqlalchemy pyotp qrcode pillow


â¸»

Ã‰tapeÂ 1 â€“ Initialiser lâ€™application Flask

# app.py
from flask import Flask, render_template, redirect, url_for, request, session
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, login_user, login_required, current_user, logout_user
import pyotp, qrcode, io, base64

app = Flask(__name__)
app.config.update(
  SECRET_KEY="supersecret",
  SQLALCHEMY_DATABASE_URI="sqlite:///users.db",
  SQLALCHEMY_TRACK_MODIFICATIONS=False
)
db = SQLAlchemy(app)
login_manager = LoginManager(app)


â¸»

Ã‰tapeÂ 2 â€“ ModÃ¨le utilisateur avec 2FA

# app.py (suite)
class User(db.Model):
  id = db.Column(db.Integer, primary_key=True)
  username = db.Column(db.String(80), unique=True, nullable=False)
  password = db.Column(db.String(120), nullable=False)
  totp_secret = db.Column(db.String(16), nullable=True)

  def get_totp_uri(self):
    return pyotp.totp.TOTP(self.totp_secret).provisioning_uri(
      self.username, issuer_name="MonApp"
    )

  def verify_totp(self, token):
    return pyotp.TOTP(self.totp_secret).verify(token)

CrÃ©ez la baseâ€¯:

python -c "from app import db; db.create_all()"


â¸»

Ã‰tapeÂ 3 â€“ Enregistrement et gÃ©nÃ©ration du QR-code

@app.route("/register", methods=["GET","POST"])
def register():
  if request.method=="POST":
    u = User(username=request.form["username"],
             password=request.form["password"],
             totp_secret=pyotp.random_base32())
    db.session.add(u); db.session.commit()
    otp_uri = u.get_totp_uri()
    img = qrcode.make(otp_uri)
    buf = io.BytesIO(); img.save(buf, format="PNG")
    qr = base64.b64encode(buf.getvalue()).decode()
    return render_template("show_qr.html", qr=qr)
  return render_template("register.html")

	â€¢	GÃ©nÃ©rez totp_secret unique
	â€¢	CrÃ©ez un QR-code pour le scanner avec lâ€™app 2FA  ï¿¼ ï¿¼ ï¿¼ ï¿¼ ï¿¼

â¸»

Ã‰tapeÂ 4 â€“ Login avec vÃ©rification TOTP en deux temps

@app.route("/login", methods=["GET","POST"])
def login():
  if request.method=="POST":
    u = User.query.filter_by(username=request.form["username"],
                               password=request.form["password"]).first()
    if u:
      session["pre_2fa_userid"] = u.id
      return redirect(url_for("two_factor"))
  return render_template("login.html")

@app.route("/two_factor", methods=["GET","POST"])
def two_factor():
  uid = session.get("pre_2fa_userid")
  if not uid: return redirect(url_for("login"))
  u = User.query.get(uid)
  if request.method=="POST":
    if u.verify_totp(request.form["token"]):
      login_user(u); return redirect(url_for("dashboard"))
  return render_template("two_factor.html")

	â€¢	Ã‰tape 1 : mot de passe â†’ sauvegarde temporaire de lâ€™utilisateur en session
	â€¢	Ã‰tape 2 : validation TOTP via verify_totp() ()

â¸»

Ã‰tapeÂ 5 â€“ Routes protÃ©gÃ©es et dÃ©connexion

@app.route("/dashboard")
@login_required
def dashboard():
  return f"Bonjour {current_user.username}, 2FA activÃ©â€¯!"

@app.route("/logout")
@login_required
def logout():
  logout_user()
  return redirect(url_for("login"))


â¸»

Ã‰tapeÂ 6 â€“ Templates basiques
	â€¢	register.html : formulaire username, password
	â€¢	show_qr.html : affichage <img src="data:image/png;base64,{{ qr }}">
	â€¢	login.html : formulaire username, password
	â€¢	two_factor.html : formulaire token
	â€¢	dashboard.html : accessible aprÃ¨s login 2FA

â¸»

ğŸ§  PiÃ¨ges & bonnes pratiques
	â€¢	VÃ©rifiez rÃ©utilisation ou rejets des tokens (anti-replay)  ï¿¼ ï¿¼ ï¿¼ ï¿¼
	â€¢	Activez HTTPS pour sÃ©curiser le totp_secret
	â€¢	PrÃ©voir une gestion IPv6 et rate-limiting contre bruteforce ï¿¼ ï¿¼

â¸»

ğŸ§ª Quiz de consolidation
	1.	Pourquoi stocker totp_secret ?
	2.	Quel est le rÃ´le du QR-code ?
	3.	Pourquoi passer par une Ã©tape â€œpre_2fa_useridâ€ ?
	4.	Que se passe-t-il si lâ€™horloge est dÃ©calÃ©e ?
	5.	Comment Ã©viter les attaques par retransmission ?

â¸»

âœ… Extensions possibles
	â€¢	Ajouter SMS 2FA avec Flaskâ€‘Security ou Twilio  ï¿¼ ï¿¼
	â€¢	Activer Â«â€¯se souvenir de cet appareilâ€¯Â» (7 jours)
	â€¢	ImplÃ©menter rÃ©cupÃ©ration sÃ©curisÃ©e (backup codes, email)

â¸»

âœ… RÃ©sultat attendu
	â€¢	Inscription gÃ©nÃ¨re un QR-code Ã  scanner
	â€¢	Connexion en deux Ã©tapes : mot de passe + TOTP
	â€¢	AccÃ¨s conditionnel selon validation du token
	â€¢	Base propre pour ajouter du MFA complet en production.

---

### Sources  
- ImplÃ©mentation Flask + PyOTP & Google Authenticator  [oai_citation:13â€¡FreeCodeCamp](https://www.freecodecamp.org/news/how-to-implement-two-factor-authentication-in-your-flask-app/?utm_source=chatgpt.com)  
- Explications TOTP, HOTP & synchronisation temporelle  [oai_citation:14â€¡pyauth.github.io](https://pyauth.github.io/pyotp/?utm_source=chatgpt.com)  
- Gestion sÃ©curisÃ©e de sessions 2FA en deux pages ()