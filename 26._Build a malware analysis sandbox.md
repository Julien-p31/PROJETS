# Tutoriel : Construire un sandbox d’analyse malware sécurisé

## 🎯 Objectif  
Créer un environnement isolé (virtualisé ou conteneurisé) pour exécuter des malwares en sécurité, analyser leur comportement, collecter des indicateurs et rapporter des IOCs exploitables.

## 🧠 Scénario d’ancrage émotionnel  
Vous recevez une pièce jointe suspecte d'un client. Vous devez l'exécuter sans infecter vos systèmes, comprendre son comportement et enrichir vos défenses.

---

## 🛠️ Prérequis  
- Hôte Linux (Ubuntu/Debian)  
- Virtualisation : VirtualBox/VMware ou Docker/Kasm  
- Outils : **Cuckoo Sandbox** (ou CAPE), agents invités, Wireshark, Procmon, Sysmon  
- python, pip, git, `sudo`

---

## 🧩 Étape 1 – Choisir votre stratégie

- **VMs isolées** (ex. Windows/Linux) : séparation complète du host   
- **Conteneurs** (Docker/Kubernetes) : plus légers, mais attention à l'isolement   
- **Cloud interactif** (ANY.RUN) : rapide, mais moins contrôlable 

---

## 🧩 Étape 2 – Architecture du sandbox

- **Host** : orchestrateur Cuckoo  
- **Worker machines** : VMs isolées exécutant les malwares, connectées via réseau cloisonné  
- **Stockage** : résultats, PCAPs, screenshots 

---

## 🔧 Étape 3 – Installation et configuration de Cuckoo

```bash
sudo apt update
pip install cuckoo vmcloak
sudo useradd -m cuckoo
su - cuckoo
virtualenv ~/cuckoo-env && source ~/cuckoo-env/bin/activate
pip install cuckoo vmcloak
cuckoo machine --add win7
vmcloak-base image, snapshot
cuckoo config
cuckoo community --update
cuckoo start

	•	Installez l’agent Cuckoo sur VM et prenez un snapshot
	•	Configurez host-only network pour cloisonner les VMs et éviter les fuites de données

⸻

🧩 Étape 4 – Exécution de l’analyse
	1.	Soumettez un sample :

cuckoo submit /chemin/vers/malware.exe


	2.	Cuckoo démarre la VM, exécute le sample, collecte logs, captures réseaux et screenshots
	3.	Un rapport JSON, PCAP, rapports API/process/fichiers est généré

⸻

🔍 Étape 5 – Collecte & enrichissement
	•	Récupérez IOCs : fichiers créés, clés registre, IP externes
	•	Visualisez le trafic PCAP avec Wireshark
	•	Intégrez les IOCs dans votre SIEM ou MISP
	•	Exportez les rapports (JSON, HTML) pour documentation

⸻

🧠 Étape 6 – Détection d’évasions & anti-sandbox
	•	Simulez présence humaine (movements/mouse, macros Word)
	•	Modifiez les snapshots pour éviter reconnaissance d’environnement virtuel
	•	Analysez les rapports pour échecs ou erreurs d’exécution

⸻

🧪 Quiz de consolidation
	1.	Pourquoi utiliser un snapshot VM ?
	2.	Quelle isolation faut-il pour prévenir les fuites réseau ?
	3.	Que collecte Cuckoo lors de l’exécution ?
	4.	Comment déjouer les détections anti-sandbox ?
	5.	Où intégrer les IOCs obtenus ?

⸻

✅ Cas d’usage concret
	•	Analyse d’un exécutable Windows suspect
	•	Extraction d’indicateurs pour enrichissement SIEM ou firewall
	•	Plateforme de détection centralisée pour l’équipe SOC

⸻

🔧 Extensions possibles
	•	Ajouter CAPE pour analyses modernes (support Python 3)
	•	Intégrer Elastic Stack pour collecte et visualisation en temps réel
	•	Automatiser avec scripts pour déploiement cloud (Terraform/Ansible + Guacamole)

⸻

🎓 Résultat attendu
	•	Sandbox opérationnel avec au moins 1 VM isolée
	•	Soumission et exécution de samples
	•	Rapports exploitables : IOCs, traces réseau, changements système
	•	Processus reproductible, sécurisé et nettoyable

---

### 📚 Sources principales  
- Tutoriel "How to Build a Custom Malware Analysis Sandbox"   
- Documentation officielle Cuckoo Sandbox   
- Guides retours d’expérience (Elastic, ANY.RUN, Hatching)   
- Archi visuelle de sandbox/VM isolées   
