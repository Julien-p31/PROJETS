# Tutoriel : SÃ©curiser des conteneurs dans une architecture microservices  

## ğŸ¯ Objectif  
DÃ©ployer une application microservices containerisÃ©e avec sÃ©curitÃ© renforcÃ©eâ€¯: image hardening, rÃ©seau segmentÃ©, communication chiffrÃ©e, gestion des secrets, et surveillance runtime.

## ğŸ§  ScÃ©nario Ã©motionnel  
Vous exploitez un eâ€‘shop en microservicesâ€¯: chaque service (utilisateur, paiement, produits) dans un container Docker et orchestrÃ© via Kubernetes. Vous devez empÃªcher injection de malware, latÃ©ralitÃ© et exfiltration.

---

## ğŸ› ï¸ PrÃ©requis  
- Kubernetes ou Docker-compose (Ubuntu/Debian)  
- Outilsâ€¯: Docker, Kubernetes, Istio, Trivy, Falco, Vault  
- Code simple : 3 microservices en Python/Node exposÃ©s via API Gateway

---

## ğŸ§© Ã‰tapeâ€¯1 â€“ Hardening des images

- Utilisez des **images minimales** (Alpine, Distroless) et scannez-les :
  ```bash
  trivy image yourservice:latest

	â€¢	Ne pas utiliser root: dans Dockerfile :

FROM python:3.10-alpine
RUN addgroup -S app && adduser -S app -G app
USER app



â†’ Ã§a rÃ©duit la surface dâ€™attaque  ï¿¼

â¸»

ğŸ§© Ã‰tapeâ€¯2 â€“ Signer les images et contrÃ´ler provenance
	â€¢	Activez Docker Content Trust :

export DOCKER_CONTENT_TRUST=1
docker build -t repo/serv:tag .
docker push repo/serv:tag


	â€¢	Configurez Kubernetes pour refuser les images non signÃ©es Ã  dÃ©ploiement  ï¿¼

â¸»

ğŸ§© Ã‰tapeâ€¯3 â€“ Gestion des secrets
	â€¢	Utilisez HashiCorp Vault (ou Kubernetes Secrets chiffrÃ©s)
	â€¢	Exemple en Python :

import hvac
client = hvac.Client(url='http://vault:8200', token='...')
db_pass = client.secrets.kv.v2.read_secret_version(path='db')['data']['data']['password']



â†’ jamais de clÃ© dans lâ€™image  ï¿¼

â¸»

ğŸ§© Ã‰tapeâ€¯4 â€“ Communication sÃ©curisÃ©e entre services
	â€¢	Activez mTLS via Istioâ€¯:

apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
spec:
  mtls:
    mode: STRICT


	â€¢	Ajoutez API Gateway avec validation JWT/OAuth2  ï¿¼

â¸»

ğŸ§© Ã‰tapeâ€¯5 â€“ Network policies / micro-segmentation
	â€¢	Kubernetes NetworkPolicy pour restreindre communications :

kind: NetworkPolicy
spec:
  podSelector: {matchLabels:{app:payment}}
  ingress: [{from:[{podSelector:{app:api-gateway}}]}]



â†’ empÃªche un container piratÃ© de communiquer librement  ï¿¼

â¸»

ğŸ§© Ã‰tapeâ€¯6 â€“ Surveillance et dÃ©fense runtime
	â€¢	Falco pour dÃ©tecter comportements suspects :

- rule: Unexpected Network in Container
  condition: evt.type=connect and not proc.name in ("curl","wget")
  output: "Process %proc.name in container %container.id attempted network connect"


	â€¢	Audit logs via API Gateway & Envoy, mÃ©triques Prometheus/ELK

â¸»

ğŸ§© Ã‰tapeâ€¯7 â€“ CI/CD & scanning automatisÃ©
	â€¢	IntÃ©grez Trivy dans pipeline :

- name: Scan image
  run: trivy image --exit-code 1 repo/service:latest


	â€¢	Analyse IaC (Terraform, Helm) avec KICS/TFSec  ï¿¼

â¸»

ğŸ§  Ã‰tapeâ€¯8 â€“ Mise Ã  jour et gestion des vulnÃ©rabilitÃ©s
	â€¢	Mettez Ã  jour containers & orchestrateur rÃ©guliÃ¨rement
	â€¢	Re-scan pÃ©riodique des images
	â€¢	Gestion des vulnÃ©rabilitÃ©s critiques selon CVSS+ ticketing

â¸»

ğŸ§ª Quiz de consolidation
	1.	Pourquoi choisir Alpine ou Distrolessâ€¯?
	2.	Quel est lâ€™intÃ©rÃªt de signer les imagesâ€¯?
	3.	Comment mTLS protÃ¨ge-t-il la communication microservicesâ€¯?
	4.	Pourquoi segmenter via NetworkPolicyâ€¯?
	5.	Quel est le rÃ´le de Falco en runtimeâ€¯?

â¸»

âœ… Cas dâ€™usage
	â€¢	Application eâ€‘commerce en microservices docker/K8s
	â€¢	Architecture sÃ©curisÃ©e Â« zero trust Â» interne
	â€¢	DevSecOps avec CI/CD, protection runtime & secrets management

â¸»

ğŸ”§ Extensions possibles
	â€¢	Ajouter un service mesh complet (Istio + Mixer policies)
	â€¢	DÃ©ployer OPA/Gatekeeper pour policies admission
	â€¢	IntÃ©grer dÃ©tection dâ€™anomalies eBPF (Cilium, Falco)
	â€¢	Automatiser remÃ©diation via SOAR pour vulnÃ©rabilitÃ©s critiques

â¸»

ğŸ“ RÃ©sultat attendu
	â€¢	Services isolÃ©s, communication chiffrÃ©e, secrets bien protÃ©gÃ©s
	â€¢	DÃ©tection en temps rÃ©el dâ€™attaques containers
	â€¢	Pipeline CI/CD sÃ©curisÃ© : buildâ†’scanâ†’dÃ©ploiementâ†’monitoring

---

### ğŸ“š Sources utilisÃ©es  
- CSA, NIST SP 800â€‘190 : best practices container & microservices  [oai_citation:6â€¡wiz.io](https://www.wiz.io/academy/microservices-security-best-practices?utm_source=chatgpt.com) [oai_citation:7â€¡Cloud Security Alliance](https://cloudsecurityalliance.org/artifacts/best-practices-for-implementing-a-secure-application-container-architecture?utm_source=chatgpt.com) [oai_citation:8â€¡jit.io](https://www.jit.io/resources/devsecops/7-best-practices-for-container-security?utm_source=chatgpt.com) [oai_citation:9â€¡en.wikipedia.org](https://en.wikipedia.org/wiki/Microservices?utm_source=chatgpt.com) [oai_citation:10â€¡apriorit.com](https://www.apriorit.com/dev-blog/558-microservice-container-security-best-practices?utm_source=chatgpt.com)  
- IntÃ©gration des 10 pratiques (image hardening, secrets, segmentationâ€¦)  [oai_citation:11â€¡Legit Security](https://www.legitsecurity.com/aspm-knowledge-base/container-security-best-practices?utm_source=chatgpt.com)  
- SÃ©curitÃ© des communications mTLS, API gateway, least-privilege  [oai_citation:12â€¡wiz.io](https://www.wiz.io/academy/microservices-security-best-practices?utm_source=chatgpt.com)